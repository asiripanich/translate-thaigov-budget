---
title: "ThaiGov's 2022 Budget"
output: github_document
always_allow_html: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```

```{r, include = FALSE}
library(targets)
```

```{r, include = FALSE}
tar_unscript()
```

<blockquote class="twitter-tweet"><p lang="th" dir="ltr">[ Excel <a href="https://twitter.com/hashtag/%E0%B8%87%E0%B8%9A65?src=hash&amp;ref_src=twsrc%5Etfw">#งบ65</a> สำเร็จแล้ว! ใช้ไปเลยชั่วลูกชั่วหลาน ]<br><br>ดาวน์โหลด: <a href="https://t.co/PuhflF8DEF">https://t.co/PuhflF8DEF</a><br><br>เราจะทำตามสัญญา ขอเวลาอีกไม่นาน ...<br><br>หลัง งปม. วาระ 1 ผ่านสภา พวกเราเคยให้สัญญากับทุกท่านไว้ว่า จะรวมพลังสาย dev เพื่อแปลงงบ pdf สู่ machine-readable แบบทำครั้งเดียว ใช้ได้ชั่วลูกชั่วหลาน <a href="https://t.co/b0pWMF3jDc">pic.twitter.com/b0pWMF3jDc</a></p>&mdash; ณัฐพงษ์ เรืองปัญญาวุฒิ (เท้ง) (@teng_mfp) <a href="https://twitter.com/teng_mfp/status/1417872910383865859?ref_src=twsrc%5Etfw">July 21, 2021</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> 


This repository contains R code that uses [Google Translation API](https://cloud.google.com/translate) to translate [2022 Thai Government Budget data](https://github.com/kaogeek/thailand-budget-pdf2csv) from Thai to English. A *partially* translated version of the data can be viewed and downloaded from here: 

> https://docs.google.com/spreadsheets/d/1rKR1kLuSDssT0_xLpGE_oRm2tPD5ZRhzErWq-8UzH6A/edit?usp=sharing

So far I have only translated `ministry`, `budgetary_unit`, `budget_plan`, `output`, and `category_lv1` columns using my free Google monthly quota. If you are interested to contribute, please submit a pull request with other columns translated to English. Feel free to use the R code below. :)

```{targets, tar_globals = TRUE}
options(tidyverse.quiet = TRUE)
tar_option_set(packages = c("dplyr", "ggplot2", "googlesheets4", "tidyr", "skimr", "magrittr", "googleLanguageR", "data.table"))
merge_translation <- function(x, translation, column) {
  translation %>%
    merge(x, ., by.x = column, by.y = "text") %>%
    select(-detectedSourceLanguage) %>%
    rename_with( ~ gsub("translatedText", paste0(column, "_en"), .x, fixed = TRUE))
}
```

# Targets

```{targets budget_raw, tar_simple = TRUE}
read_sheet("https://docs.google.com/spreadsheets/d/1yyWXSTbq3CD_gNxks-krcSBzbszv3c_2Nq54lckoQ24/edit#gid=1625073248")
```

```{targets data-prep}
list(
  tar_target(budget, budget_raw %>% janitor::clean_names()),
  tar_target(unique_sentences, {
    budget %>%
      select(
        ministry,
        budgetary_unit,
        budget_plan,
        output,
        project,
        starts_with("category"),
        item_description
      ) %>% {
        as.character(unique(unlist(.)))
      }
  })
)
```

<!-- ```{targets chunks_of_unique_sentences, tar_simple = TRUE} -->
<!-- unique_sentences %>% -->
<!--   sample(size = 20, replace = FALSE) %>% -->
<!--   split(., ceiling(seq_along(.) / 5)) -->
<!-- ``` -->

```{targets translation}
list(
  tar_target(translated_ministry, {
    budget$ministry %>%
      unique() %>%
      gl_translate(target = "en")
  }),
  tar_target(translated_budgetary_unit, {
    budget$budgetary_unit %>%
      unique() %>%
      gl_translate(target = "en")
  }),
  tar_target(translated_budget_plan, {
    budget$budget_plan %>%
      unique() %>%
      gl_translate(target = "en")
  }),
  tar_target(translated_output, {
    budget$output %>%
      unique() %>%
      gl_translate(target = "en")
  }),
  tar_target(translated_category_lv1, {
    budget$category_lv1 %>%
      unique() %>%
      gl_translate(target = "en")
  })
)
```

<!-- ```{targets translate-by-chunk}  -->
<!-- list( -->
<!--   tar_target( -->
<!--     translated_chucks,  -->
<!--     gl_translate(chunks_of_unique_sentences[[1]], target = "en"),  -->
<!--     pattern = map(chunks_of_unique_sentences),  -->
<!--     iteration = "list" -->
<!--   ) -->
<!-- ) -->
<!-- ``` -->

```{targets translated_budget, tar_simple = TRUE}
budget %>%
  merge_translation(translated_ministry, "ministry") %>%
  merge_translation(translated_budgetary_unit, "budgetary_unit") %>%
  merge_translation(translated_budget_plan, "budget_plan") %>%
  merge_translation(translated_output, "output") %>%
  merge_translation(translated_category_lv1, "category_lv1") %>%
  select(names(budget), everything())
```

```{targets upload_to_gsheet, tar_simple = TRUE}
# googlesheets4::gs4_create("65_thailand_budget_extracted_b4_cleansing_with_ENlang",
#            sheets = list(DATA = head(translated_budget, 10)))
googlesheets4::sheet_write(
  data = translated_budget,
  ss = "https://docs.google.com/spreadsheets/d/1rKR1kLuSDssT0_xLpGE_oRm2tPD5ZRhzErWq-8UzH6A/edit?usp=sharing",
  sheet = "DATA"
)
```

# Pipeline

```{r}
tar_make()
```

```{r visnetwork}
tar_visnetwork()
```

# Example Output

```{r, message=FALSE}
library(dplyr)
library(skimr)
library(ggplot2)
library(kableExtra)
library(stringr)
library(forcats)
library(scales)
```

```{r}
tar_load(translated_budget)
cols_to_select <- names(translated_budget)[grepl("_en", names(translated_budget))]
cols_to_select <- c(gsub("_en", "", cols_to_select), cols_to_select) %>% sort()

translated_budget %>%
  dplyr::select(cols_to_select) %>%
  dplyr::slice_sample(n = 10) %>%
  kableExtra::kbl() 
```

```{r total-budget-by-ministry, fig.height=10, dpi=300}
tar_read(budget_en) %>%
  mutate(ministry_en = ifelse(grepl("Ministry of Higher Education", ministry_en) == TRUE, 
                               "Ministry of Higher Education, Science, Research and Innovation",
                               ministry_en)) %>%
  group_by(ministry_en) %>%
  summarise(amount = sum(amount, na.rm = TRUE)) %>%
  ggplot(data = ., aes(
    x = amount,
    y = forcats::fct_reorder(stringr::str_wrap(ministry_en, 40), amount)
  )) +
  geom_col() +
  scale_x_continuous(labels = unit_format(unit = "M", scale = 1e-6, big.mark = ",")) +
  scale_y_discrete(expand = c(0, 0)) +
  theme_bw(base_size = 12) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(x = "Amount in Million Thai Bahts", y = "Ministry")
```

```{r}
tar_read(budget) %>%
  skimr::skim()
```


